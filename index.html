<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kernel Project</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      color:#fff;font-family:Inter,system-ui,sans-serif;
      background:linear-gradient(-45deg,#050006,#100018,#180029,#000);
      background-size:400% 400%;
      animation:gradientMove 20s ease infinite;
      min-height:100vh;
    }
    @keyframes gradientMove {0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    header{background:rgba(10,10,16,.6);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.05)}
    .card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:18px}
    .input{width:100%;padding:.6rem .8rem;border-radius:10px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);color:#fff}
    .label{display:block;margin-bottom:.25rem;color:rgba(255,255,255,.7);font-size:.86rem}
    .btn{padding:.55rem 1rem;border-radius:10px;font-weight:600;cursor:pointer;transition:.18s}
    .btn-primary{background:linear-gradient(90deg,#7e22ce,#4c1d95);color:#fff}
    .btn-ghost{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08)}
    .price-old{text-decoration:line-through;opacity:.6;margin-right:.4rem}
    .price-new{color:#c084fc;font-weight:700}
    .badge{font-size:.7rem;background:#6b21a8;padding:.2rem .5rem;border-radius:.5rem}
  </style>
</head>
<body class="min-h-screen">

<header class="flex items-center justify-between px-6 py-4">
  <div class="flex items-center gap-2 font-bold text-lg">
    <span class="text-fuchsia-400">⚡</span>
    <span class="bg-gradient-to-r from-fuchsia-400 via-purple-400 to-indigo-400 bg-clip-text text-transparent">Kernel Project</span>
  </div>
  <div id="headerUser" class="opacity-80 text-sm">Гость</div>
</header>

<main id="app" class="max-w-6xl mx-auto p-6"></main>
<footer class="mt-12 text-center text-white/40 text-xs">Kernel Project © 2025</footer>

<script>
const API = "https://sajtept.onrender.com/api"; // ⚠️ замени на свой backend
let token = localStorage.getItem("token");
let currentUser = null;

/* API helper */
async function api(path, method="GET", data=null) {
  const res = await fetch(API+path,{
    method,
    headers:{
      "Content-Type":"application/json",
      ...(token?{Authorization:"Bearer "+token}:{})
    },
    body:data?JSON.stringify(data):null
  });
  let txt = await res.text();
  try { return JSON.parse(txt); }
  catch { throw new Error("Ошибка сервера: "+txt.slice(0,100)); }
}

/* UI рендеры */
function renderHero(){
  document.getElementById("app").innerHTML=`
    <div class="text-center mt-16">
      <h1 class="text-3xl font-bold mb-4">Добро пожаловать в Kernel Project</h1>
      <button class="btn btn-primary" onclick="renderAuth()">Get Started</button>
    </div>`;
}

function renderAuth(){
  document.getElementById("app").innerHTML=`
    <div class="grid md:grid-cols-2 gap-6 mt-12">
      <div class="card">
        <h2 class="text-xl font-bold mb-4">Вход</h2>
        <label class="label">E-mail</label><input class="input mb-3" id="login_email">
        <label class="label">Пароль</label><input class="input mb-4" id="login_pass" type="password">
        <button class="btn btn-primary w-full" onclick="login()">Войти</button>
      </div>
      <div class="card">
        <h2 class="text-xl font-bold mb-4">Регистрация</h2>
        <label class="label">E-mail</label><input class="input mb-3" id="reg_email">
        <label class="label">Имя</label><input class="input mb-3" id="reg_name">
        <label class="label">Пароль</label><input class="input mb-4" id="reg_pass" type="password">
        <button class="btn btn-primary w-full" onclick="register()">Создать аккаунт</button>
      </div>
    </div>`;
}

async function login(){
  try{
    let email=document.getElementById("login_email").value.trim();
    let password=document.getElementById("login_pass").value.trim();
    let res=await api("/login","POST",{email,password});
    token=res.token;localStorage.setItem("token",token);currentUser=res.user;
    renderShop();
  }catch(e){alert(e.message);}
}

async function register(){
  try{
    let email=document.getElementById("reg_email").value.trim();
    let displayName=document.getElementById("reg_name").value.trim();
    let password=document.getElementById("reg_pass").value.trim();
    await api("/register","POST",{email,password,displayName});
    alert("Аккаунт создан! Теперь войдите.");
    renderAuth();
  }catch(e){alert(e.message);}
}

async function renderShop(){
  document.getElementById("headerUser").textContent=currentUser?currentUser.email:"Гость";
  let prods=await api("/products");
  let html=`<div class="flex gap-3 mb-6">
    <button class="btn btn-ghost" onclick="logout()">Выйти</button>
    <button class="btn btn-ghost" onclick="renderProfile()">Профиль</button>
    ${currentUser&&currentUser.role==="admin"?`<button class="btn btn-primary" onclick="renderAdmin()">Админка</button>`:""}
  </div><div class="grid sm:grid-cols-2 md:grid-cols-3 gap-4">`;
  for(let p of prods){
    html+=`
      <div class="card">
        <div class="flex justify-between mb-2">
          <div class="font-semibold">${p.title}</div>
          ${p.pinned?'<span class="badge">Закреп</span>':""}
        </div>
        <div class="text-sm text-white/70">${p.description||""}</div>
        <div class="mt-2">${p.discount>0?`<span class="price-old">${p.price}₽</span><span class="price-new">${Math.round(p.price*(1-p.discount/100))}₽ (-${p.discount}%)</span>`:`<span class="price-new">${p.price}₽</span>`}</div>
        <div class="mt-3 flex flex-wrap gap-2">
          ${p.file_url?`<a class="btn btn-primary text-sm" href="${p.file_url}" target="_blank">Скачать</a>`:""}
          ${p.funpay_url?`<a class="btn btn-primary text-sm" href="${p.funpay_url}" target="_blank">Купить (FunPay)</a>`:""}
          ${p.star_url?`<a class="btn btn-primary text-sm" href="${p.star_url}" target="_blank">Купить (Звёзды)</a>`:""}
        </div>
      </div>`;
  }
  html+="</div>";
  document.getElementById("app").innerHTML=html;
}

function logout(){token=null;localStorage.removeItem("token");currentUser=null;renderHero();}

/* Профиль + смена пароля */
function renderProfile(){
  document.getElementById("app").innerHTML=`
    <div class="card max-w-md mx-auto mt-12">
      <h2 class="text-xl mb-4">Профиль: ${currentUser.displayName||currentUser.email}</h2>
      <label class="label">Новый пароль</label><input class="input mb-3" id="new_pass" type="password">
      <button class="btn btn-primary w-full" onclick="changePassword()">Сменить пароль</button>
    </div>`;
}
async function changePassword(){
  try{
    let newPass=document.getElementById("new_pass").value.trim();
    await api("/change-password","POST",{password:newPass});
    alert("Пароль изменён!");
    renderShop();
  }catch(e){alert(e.message);}
}

/* Админка */
function renderAdmin(){
  document.getElementById("app").innerHTML=`
    <div class="card">
      <h2 class="text-lg font-bold mb-4">Добавить товар</h2>
      <label class="label">Название</label><input class="input mb-2" id="prod_title">
      <label class="label">Описание</label><input class="input mb-2" id="prod_desc">
      <label class="label">Цена</label><input class="input mb-2" id="prod_price" type="number">
      <label class="label">Скидка (%)</label><input class="input mb-2" id="prod_discount" type="number" value="0">
      <label class="label">Закрепить</label><input id="prod_pinned" type="checkbox" class="mb-2">
      <label class="label">Ссылка для скачивания</label><input class="input mb-2" id="prod_file">
      <label class="label">Ссылка FunPay</label><input class="input mb-2" id="prod_funpay">
      <label class="label">Ссылка Звёзды</label><input class="input mb-2" id="prod_star">
      <button class="btn btn-primary mt-2" onclick="addProduct()">Добавить</button>
    </div>
    <button class="btn btn-ghost mt-6" onclick="renderShop()">Назад</button>`;
}
async function addProduct(){
  try{
    let data={
      title:document.getElementById("prod_title").value,
      description:document.getElementById("prod_desc").value,
      price:+document.getElementById("prod_price").value,
      discount:+document.getElementById("prod_discount").value,
      pinned:document.getElementById("prod_pinned").checked,
      type:"buy",
      fileUrl:document.getElementById("prod_file").value,
      funpayUrl:document.getElementById("prod_funpay").value,
      starUrl:document.getElementById("prod_star").value
    };
    await api("/products","POST",data);
    alert("Товар добавлен!");
    renderShop();
  }catch(e){alert(e.message);}
}

renderHero();
</script>
</body>
</html>
