<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Kernel Project</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --glass-bg: rgba(255,255,255,0.05);
      --glass-border: rgba(255,255,255,0.12);
    }
    body {
      color:#fff;
      font-family:Inter,system-ui,sans-serif;
      background:linear-gradient(-45deg,#000010,#001030,#002050,#001018);
      background-size:400% 400%;
      animation:gradientMove 18s ease infinite;
      min-height:100vh;
    }
    @keyframes gradientMove {
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }
    header {
      background:rgba(10,10,20,0.55);
      backdrop-filter:blur(6px);
      border-bottom:1px solid rgba(255,255,255,0.03);
      padding:18px 24px;
    }
    .brand {
      font-weight:700;
      font-size:1.2rem;
      color:#a5b4fc;
    }
    /* üîò –°—Ç–µ–∫–ª—è–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
    .btn {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:.55rem 1.1rem;
      border-radius:12px;
      font-weight:600;
      cursor:pointer;
      border:1px solid var(--glass-border);
      background:rgba(255,255,255,0.05);
      color:#fff;
      backdrop-filter:blur(12px) saturate(150%);
      transition:.2s;
    }
    .btn:hover { transform:translateY(-2px); background:rgba(255,255,255,0.1); }
    .btn-primary {
      border:1px solid rgba(255,255,255,0.3);
      background:rgba(255,255,255,0.08);
    }
    .card {
      background:var(--glass-bg);
      border:1px solid var(--glass-border);
      border-radius:14px;
      padding:18px;
      animation:fadeIn .45s ease both;
    }
    .input {
      width:100%;padding:.62rem .85rem;border-radius:10px;
      background:rgba(255,255,255,0.025);
      border:1px solid rgba(255,255,255,0.06);
      color:#fff;
    }
    .label {display:block;margin-bottom:.25rem;color:rgba(255,255,255,.72);font-size:.88rem}
    .hero {text-align:center;padding:60px 16px 36px;}
    .hero h1 {font-size:2.6rem;margin-bottom:.6rem;color:#dbeafe;}
    .price-old{text-decoration:line-through;opacity:.6;margin-right:.5rem}
    .price-new{color:#bfdbfe;font-weight:800}
    #toast {position:fixed;bottom:1rem;right:1rem;z-index:999;display:flex;flex-direction:column;gap:.5rem}
    .toast-msg{background:rgba(14,14,20,0.95);padding:.6rem .9rem;border-radius:10px;font-size:.95rem}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    /* üì± –ü–æ–¥ –º–æ–±–∏–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
    @media(max-width:640px){
      .hero button {display:block;width:100%;margin:8px 0!important;}
    }
  </style>
</head>
<body>
<header class="flex items-center justify-between">
  <div class="flex items-center gap-2">
    <div>
      <div class="brand">Kernel Project</div>
    </div>
  </div>
  <div id="headerUser" class="opacity-80 text-sm">–ì–æ—Å—Ç—å</div>
</header>

<main id="app" class="max-w-6xl mx-auto p-6"></main>
<div id="toast"></div>
<footer class="mt-12 text-center text-white/40 text-xs pb-8">
  Kernel Project ¬© 2025
</footer>

<script>
const API="https://sajtept.onrender.com/api";
let token=localStorage.getItem("token");
let currentUser=null;

function toast(msg){
  let t=document.createElement("div");
  t.className="toast-msg";
  t.innerText=msg;
  document.getElementById("toast").appendChild(t);
  setTimeout(()=>t.remove(),3000);
}

async function api(path,method="GET",data=null){
  const res=await fetch(API+path,{
    method,
    headers:{"Content-Type":"application/json",...(token?{Authorization:"Bearer "+token}:{})},
    body:data?JSON.stringify(data):null
  });
  if(res.status===401){ // ‚ùå —Å–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞
    token=null;localStorage.removeItem("token");currentUser=null;
    toast("–°–µ—Å—Å–∏—è —É—Å—Ç–∞—Ä–µ–ª–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.");
    renderAuth();return;
  }
  let txt=await res.text();
  try{return JSON.parse(txt);}catch{throw new Error(txt);}
}

/* --- –ì–ª–∞–≤–Ω–∞—è --- */
function renderHero(){
  document.getElementById("app").innerHTML=`
    <section class="hero card">
      <div style="max-width:900px;margin:0 auto">
        <h1>Kernel Project</h1>
        <div style="margin-top:18px;">
          <button class="btn btn-primary" onclick="renderAuth()">Get Started</button>
          <button class="btn btn-ghost" style="margin-left:10px" onclick="renderWhy()">–ü–æ—á–µ–º—É –≤—ã –¥–æ–ª–∂–Ω—ã –≤—ã–±—Ä–∞—Ç—å –Ω–∞—Å?</button>
          <button class="btn btn-ghost" style="margin-left:10px" onclick="renderPrivacy()">–£—Å–ª–æ–≤–∏—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</button>
          <a class="btn btn-ghost" style="margin-left:10px" href="https://t.me/kernelprojec" target="_blank">–Ω–∞—à —Ç–≥–∫</a>
        </div>
      </div>
    </section>`;
}

/* --- –ü–æ—á–µ–º—É –º—ã --- */
function renderWhy(){
  document.getElementById("app").innerHTML=`
    <div class="card">
      <h2 class="text-xl font-bold mb-4">–ü–æ—á–µ–º—É –≤—ã –¥–æ–ª–∂–Ω—ã –≤—ã–±—Ä–∞—Ç—å –Ω–∞—Å?</h2>
      <ul class="text-white/80 text-left list-disc list-inside space-y-2">
        <li>–õ—É—á—à–∏–µ —Ñ–∏–∫—Å—ã —Å–æ—Ñ—Ç–æ–≤</li>
        <li>–†–µ–≥—É–ª—è—Ä–Ω—ã–µ –¥—Ä–æ–ø—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π</li>
      </ul>
      <div class="mt-4">
        <button class="btn btn-primary" onclick="renderAuth()">–ù–∞—á–∞—Ç—å</button>
        <button class="btn btn-ghost ml-2" onclick="renderHero()">–ù–∞–∑–∞–¥</button>
      </div>
    </div>`;
}

/* --- –£—Å–ª–æ–≤–∏—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ --- */
function renderPrivacy(){
  document.getElementById("app").innerHTML=`
    <div class="card text-sm leading-relaxed space-y-3">
      <h2 class="text-xl font-bold mb-4">–£—Å–ª–æ–≤–∏—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</h2>
      <p>–ú—ã —Ü–µ–Ω–∏–º –≤–∞—à—É –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –∏ –±–µ—Ä–µ–∂–Ω–æ –æ—Ç–Ω–æ—Å–∏–º—Å—è –∫ –≤–∞—à–∏–º –¥–∞–Ω–Ω—ã–º. –ò—Å–ø–æ–ª—å–∑—É—è –Ω–∞—à —Å–µ—Ä–≤–∏—Å, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å —Ç–µ–º, —á—Ç–æ:</p>
      <p><b>1. –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö</b><br>–ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –º—ã –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ: –∞–¥—Ä–µ—Å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã, –∏–º—è –∏ –ø–∞—Ä–æ–ª—å.</p>
      <p><b>2. –•—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π</b><br>–í–∞—à–∏ –ø–∞—Ä–æ–ª–∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ. –û–Ω–∏ –∑–∞—â–∏—â–µ–Ω—ã —Å –ø–æ–º–æ—â—å—é –Ω–∞–¥—ë–∂–Ω–æ–≥–æ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è (bcrypt). –î–∞–∂–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –∏–º–µ—é—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–∞—à–∏–º –ø–∞—Ä–æ–ª—è–º.</p>
      <p><b>3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ email</b><br>–£–∫–∞–∑–∞–Ω–Ω—ã–π –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ email –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è –≤—Ö–æ–¥–∞ –∏ —Å–≤—è–∑–∏. –ú—ã –Ω–µ –ø–µ—Ä–µ–¥–∞—ë–º –µ–≥–æ —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º.</p>
      <p><b>4. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</b><br>–î–ª—è –≤—Ö–æ–¥–∞ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∑–∞—â–∏—â—ë–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã. –û–Ω–∏ –¥–µ–π—Å—Ç–≤—É—é—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è.</p>
      <p><b>5. –ó–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö</b><br>–í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –ø–æ –∑–∞—â–∏—â—ë–Ω–Ω–æ–º—É —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—é (SSL/TLS). –ú—ã —Ä–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º—É –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.</p>
      <div class="mt-4">
        <button class="btn btn-ghost" onclick="renderHero()">–ù–∞–∑–∞–¥</button>
      </div>
    </div>`;
}

/* --- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è --- */
function renderAuth(){
  document.getElementById("app").innerHTML=`
    <div class="grid md:grid-cols-2 gap-6">
      <div class="card">
        <h3 class="font-bold mb-2">–í—Ö–æ–¥</h3>
        <label class="label">E-mail</label><input id="login_email" class="input mb-3"/>
        <label class="label">–ü–∞—Ä–æ–ª—å</label><input id="login_pass" class="input mb-4" type="password"/>
        <button class="btn btn-primary w-full" onclick="login()">–í–æ–π—Ç–∏</button>
      </div>
      <div class="card">
        <h3 class="font-bold mb-2">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
        <label class="label">E-mail</label><input id="reg_email" class="input mb-3"/>
        <label class="label">–ò–º—è</label><input id="reg_name" class="input mb-3"/>
        <label class="label">–ü–∞—Ä–æ–ª—å</label><input id="reg_pass" class="input mb-4" type="password"/>
        <button class="btn btn-primary w-full" onclick="register()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
      </div>
    </div>`;
}

async function login(){
  try{
    let res=await api("/login","POST",{email:login_email.value,password:login_pass.value});
    if(!res.token) throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å");
    token=res.token;localStorage.setItem("token",token);currentUser=res.user;
    toast("–í—Ö–æ–¥ —É—Å–ø–µ—à–Ω—ã–π!");renderShop();
  }catch(e){
    token=null;localStorage.removeItem("token");currentUser=null;
    toast("–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å");renderAuth();
  }
}
async function register(){
  try{
    let res=await api("/register","POST",{email:reg_email.value,password:reg_pass.value,displayName:reg_name.value});
    if(res.error&&res.error.includes("—Å—É—â–µ—Å—Ç–≤—É–µ—Ç")){toast("–¢–∞–∫–æ–π –∞–∫–∫–∞—É–Ω—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç");return;}
    toast("–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω! –í–æ–π–¥–∏—Ç–µ.");renderAuth();
  }catch(e){toast("–û—à–∏–±–∫–∞: "+e.message);}
}

/* --- –ú–∞–≥–∞–∑–∏–Ω --- */
async function renderShop(){
  let username=currentUser?.displayname||currentUser?.display_name||currentUser?.email;
  headerUser.textContent=currentUser
    ? (currentUser.role==="admin" ? `[ADMIN] ${username}` : username)
    : "–ì–æ—Å—Ç—å";
  let prods=await api("/products");
  let html=`<div class="flex flex-wrap gap-3 mb-6">
    <button class="btn btn-ghost" onclick="logout()">–í—ã–π—Ç–∏</button>
    <button class="btn btn-ghost" onclick="renderProfile()">–ü—Ä–æ—Ñ–∏–ª—å</button>
    ${currentUser?.role==="admin"?`<button class="btn btn-primary" onclick="renderAdmin()">–ê–¥–º–∏–Ω–∫–∞</button>`:""}
  </div><div class="grid sm:grid-cols-2 md:grid-cols-3 gap-4">`;
  for(let p of prods){
    html+=`
    <div class="card">
      <div class="flex justify-between mb-2">
        <div class="font-semibold">${p.title}</div>
        ${p.pinned?'<span>–ó–∞–∫—Ä–µ–ø</span>':""}
      </div>
      <div class="text-sm text-white/70">${p.description||""}</div>
      <div class="mt-2">
        ${p.discount>0
          ? `<span class="price-old">${p.price}‚ÇΩ</span>
             <span class="price-new">${Math.round(p.price*(1-p.discount/100))}‚ÇΩ (-${p.discount}%)</span>`
          : `<span class="price-new">${p.price}‚ÇΩ</span>`}
      </div>
      <div class="mt-3 flex flex-wrap gap-2">
        ${p.file_url?`<a class="btn text-sm" href="${p.file_url}" target="_blank">–°–∫–∞—á–∞—Ç—å</a>`:""}
        ${p.funpay_url?`<a class="btn text-sm" href="${p.funpay_url}" target="_blank">–ö—É–ø–∏—Ç—å (FunPay)</a>`:""}
        ${p.star_url?`<a class="btn text-sm" href="${p.star_url}" target="_blank">–ö—É–ø–∏—Ç—å (–ó–≤—ë–∑–¥—ã)</a>`:""}
      </div>
      ${currentUser?.role==="admin"
        ? `<div class="mt-3 flex gap-2">
             <button class="btn text-sm" onclick="editProduct('${p.id}','${p.title}','${p.description}','${p.price}','${p.discount}','${p.pinned}','${p.file_url}','${p.funpay_url}','${p.star_url}','${p.type}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
             <button class="btn text-sm" onclick="deleteProduct('${p.id}')">–£–¥–∞–ª–∏—Ç—å</button>
           </div>`:""}
    </div>`;
  }
  html+="</div>";app.innerHTML=html;
}

function logout(){token=null;localStorage.removeItem("token");currentUser=null;renderHero();}
function renderProfile(){app.innerHTML=`<div class="card max-w-md mx-auto"><h2 class="text-xl mb-4">–ü—Ä–æ—Ñ–∏–ª—å: ${currentUser.displayName||currentUser.email}</h2><label class="label">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label><input id="new_pass" type="password" class="input mb-3"><div class="flex gap-2"><button class="btn flex-1" onclick="changePassword()">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button><button class="btn flex-1" onclick="renderShop()">–ù–∞–∑–∞–¥</button></div></div>`;}
async function changePassword(){try{await api("/change-password","POST",{password:new_pass.value});toast("–ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω—ë–Ω!");renderShop();}catch(e){toast("–û—à–∏–±–∫–∞: "+e.message);}}

function renderAdmin(){
  app.innerHTML=`
    <div class="card">
      <h2 class="text-lg font-bold mb-4">–î–æ–±–∞–≤–∏—Ç—å/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä</h2>
      <label class="label">ID</label><input class="input mb-2" id="prod_id">
      <label class="label">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input class="input mb-2" id="prod_title">
      <label class="label">–û–ø–∏—Å–∞–Ω–∏–µ</label><input class="input mb-2" id="prod_desc">
      <label class="label">–¶–µ–Ω–∞</label><input class="input mb-2" id="prod_price" type="number">
      <label class="label">–°–∫–∏–¥–∫–∞ (%)</label><input class="input mb-2" id="prod_discount" type="number" value="0">
      <label class="label">–ó–∞–∫—Ä–µ–ø–∏—Ç—å</label><input id="prod_pinned" type="checkbox" class="mb-2">
      <label class="label">–¢–∏–ø —Ç–æ–≤–∞—Ä–∞</label>
      <select class="input mb-2" id="prod_type">
        <option value="buy">–ü–æ–∫—É–ø–∫–∞</option>
        <option value="download">–°–∫–∞—á–∏–≤–∞–Ω–∏–µ</option>
      </select>
      <label class="label">–°—Å—ã–ª–∫–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è</label><input class="input mb-2" id="prod_file">
      <label class="label">–°—Å—ã–ª–∫–∞ FunPay</label><input class="input mb-2" id="prod_funpay">
      <label class="label">–°—Å—ã–ª–∫–∞ –ó–≤—ë–∑–¥—ã</label><input class="input mb-2" id="prod_star">
      <button class="btn mt-2" onclick="saveProduct()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
    <div class="card mt-6">
      <h2 class="text-lg font-bold mb-4">–ù–∞–∑–Ω–∞—á–∏—Ç—å –∞–¥–º–∏–Ω–æ–º</h2>
      <label class="label">Email</label><input class="input mb-2" id="admin_email">
      <button class="btn" onclick="makeAdmin()">–°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º</button>
    </div>
    <button class="btn mt-6" onclick="renderShop()">–ù–∞–∑–∞–¥</button>`;
}

async function saveProduct(){
  try{
    let data={title:prod_title.value,description:prod_desc.value,price:+prod_price.value,discount:+prod_discount.value,pinned:prod_pinned.checked,type:prod_type.value,fileUrl:prod_file.value,funpayUrl:prod_funpay.value,starUrl:prod_star.value};
    if(prod_id.value){await api("/products/"+prod_id.value,"PUT",data);toast("–¢–æ–≤–∞—Ä –æ–±–Ω–æ–≤–ª—ë–Ω!");}
    else{await api("/products","POST",data);toast("–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω!");}
    renderShop();
  }catch(e){toast("–û—à–∏–±–∫–∞: "+e.message);}
}
async function makeAdmin(){
  try{
    await api("/make-admin","POST",{email:admin_email.value});
    toast("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ç–∞–ª –∞–¥–º–∏–Ω–æ–º!");
  }catch(e){toast("–û—à–∏–±–∫–∞: "+e.message);}
}
function editProduct(id,title,desc,price,discount,pinned,file,funpay,star,type){
  renderAdmin();
  prod_id.value=id;
  prod_title.value=title;
  prod_desc.value=desc;
  prod_price.value=price;
  prod_discount.value=discount;
  prod_pinned.checked=(pinned==="true"||pinned===true);
  prod_file.value=file;
  prod_funpay.value=funpay;
  prod_star.value=star;
  prod_type.value=type||"buy";
}
async function deleteProduct(id){
  if(!confirm("–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?")) return;
  try{
    await api("/products/"+id,"DELETE");
    toast("–¢–æ–≤–∞—Ä —É–¥–∞–ª—ë–Ω!");
    renderShop();
  }catch(e){toast("–û—à–∏–±–∫–∞: "+e.message);}
}

/* --- –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã --- */
(async()=>{
  if(token){
    try{
      let me=await api("/me");
      if(me?.email){currentUser=me;renderShop();return;}
    }catch{renderHero();}
  }else renderHero();
})();
</script>
</body>
</html>
